actor DGHasPlasmaRifle : Boolean {}
actor SamsaraDoom64PlasmaRifleSoundActive : Boolean {}
actor SamsaraDoomguyStrPlasmaRifleReadySoundCheck : Boolean {}

actor "Plasma Rifle" : PlasmaRifle
{
    Weapon.SlotNumber 6
    Weapon.AmmoGive 0
    +INVENTORY.UNDROPPABLE
    +ALT_USES_BOTH
	Tag "Plasma Rifle"
	Inventory.RestrictedTo "DoomguyPlayer"
    States
    {
      Spawn:
        WPLS A -1
        stop

      // Original
      Ready:
        TNT1 A 0 A_JumpIfInventory("DoomClassMode",2,"ReadyStr")
		TNT1 A 0 A_JumpIfInventory("DoomClassMode",1,"Ready64")
        TNT1 A 0 A_JumpIfInventory("SamsaraDoom64PlasmaRifleSoundActive",1,"ReadyStopSound")
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrPlasmaRifleReadySoundCheck",1,"ReadyStopSound")
      ReadyContinue:
        DPLS A 1 A_WeaponReady(WRF_NOSECONDARY)
        goto Ready

      ReadyStopSound:
        TNT1 A 0 A_PlaySound("silence",CHAN_6)
        TNT1 A 0 A_StopSound(CHAN_6)
        TNT1 A 0 A_TakeInventory("SamsaraDoom64PlasmaRifleSoundActive")
        TNT1 A 0 A_TakeInventory("SamsaraDoomguyStrPlasmaRifleReadySoundCheck")
        goto ReadyContinue

      Deselect:
        TNT1 A 0 A_JumpIfInventory("SamsaraDoom64PlasmaRifleSoundActive",1,"DeselectStopSound")
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrPlasmaRifleReadySoundCheck",1,"DeselectStopSound")
      DeselectStart:
        TNT1 A 0 A_JumpIfInventory("DoomClassMode",2,"DeselectStartStr")
		TNT1 A 0 A_JumpIfInventory("DoomClassMode",1,"DeselectStart64")
        DPLS A 1 A_Lower
        goto Deselect

      DeselectStopSound:
        TNT1 A 0 A_PlaySound("silence",CHAN_6)
        TNT1 A 0 A_StopSound(CHAN_6)
        TNT1 A 0 A_TakeInventory("SamsaraDoom64PlasmaRifleSoundActive")
        TNT1 A 0 A_TakeInventory("SamsaraDoomguyStrPlasmaRifleReadySoundCheck")
        goto DeselectStart

      Select:
        TNT1 A 0 A_TakeInventory("SamsaraDoomguyStrPlasmaRifleReadySoundCheck")
        TNT1 A 0 A_JumpIfInventory("DoomClassMode",2,"SelectStr")
		TNT1 A 0 A_JumpIfInventory("DoomClassMode",1,"Select64")
        TNT1 A 0 A_JumpIfInventory("SamsaraDoom64PlasmaRifleSoundActive",1,"SelectStopSound")
      SelectContinue:
        DPLS A 1 A_Raise
        goto Select

      SelectStopSound:
        TNT1 A 0 A_PlaySound("silence",CHAN_6)
        TNT1 A 0 A_StopSound(CHAN_6)
        TNT1 A 0 A_TakeInventory("SamsaraDoom64PlasmaRifleSoundActive")
        goto SelectContinue

      Fire:
        TNT1 A 0 A_JumpIfInventory("DoomClassMode",2,"FireStr")
		TNT1 A 0 A_JumpIfInventory("DoomClassMode",1,"Fire64")
        TNT1 A 0 A_JumpIfInventory("SamsaraDoom64PlasmaRifleSoundActive",1,"FireStopSound")
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrPlasmaRifleReadySoundCheck",1,"FireStopSound")
      FireStart:
        TNT1 A 0 A_JumpIfInventory("SamsaraUsingSmoothAnims",1,"FireSmooth")
        TNT1 A 0 A_GunFlash("Flash",GFF_NOEXTCHANGE)
        DPLS A 3 Bright A_GiveInventory("SamsaraDoomguyPlasmaRifleAttackHandler")
        DPLS H 20 A_ReFire
        goto Ready

      Flash:
	    TNT1 A 0 A_Jump(256,1,2)
	    DPLF A 3 Bright A_Light1
        goto LightDone
	    DPLF B 3 Bright A_Light1
        goto LightDone

      FireSmooth:
        TNT1 A 0 A_GunFlash("FlashSmooth",GFF_NOEXTCHANGE)
        DPLS A 3 Bright A_GiveInventory("SamsaraDoomguyPlasmaRifleAttackHandler")
        DPLS A 1 A_ReFire
        DPLS BC 1
        DPLS D 1 A_JumpIfInventory("SamsaraHasDoubleFiringSpeed",1,"FireSmoothRage")
        DPLS EF 1
        DPLS GF 3
        DPLS EDCB 2
        goto Ready

      FireSmoothRage:
        DPLS DFGFDCB 2
        goto Ready

      FireStopSound:
        TNT1 A 0 A_PlaySound("silence",CHAN_6)
        TNT1 A 0 A_StopSound(CHAN_6)
        TNT1 A 0 A_TakeInventory("SamsaraDoom64PlasmaRifleSoundActive")
        TNT1 A 0 A_TakeInventory("SamsaraDoomguyStrPlasmaRifleReadySoundCheck")
        goto FireStart

	  FlashSmooth:
		TNT1 A 0 A_Light1
        TNT1 A 0 A_JumpIfInventory("SamsaraHasDoubleFiringSpeed",1,"FlashSmoothRage")
		DPLF CABD 1 Bright
		goto LightDone

	  FlashSmoothRage:
		DPLF AD 1 Bright
		goto LightDone

      // Doom 64 (fires slower, but is more damaging)
      Ready64:
        TNT1 A 0 A_PlaySound("doom64guy/plasmaidle",CHAN_6,1,true)
        TNT1 A 0 A_GiveInventory("SamsaraDoom64PlasmaRifleSoundActive")
        TNT1 A 0 A_TakeInventory("SamsaraDoomguyStrPlasmaRifleReadySoundCheck")
        64PR BCD 2 A_WeaponReady(WRF_NOSECONDARY)
        goto Ready

      DeselectStart64:
        64PR A 1 A_Lower
        goto Deselect

      Select64:
        TNT1 A 0 A_PlaySound("doom64guy/plasmaidle",CHAN_6,1,true)
        TNT1 A 0 A_GiveInventory("SamsaraDoom64PlasmaRifleSoundActive")
        TNT1 A 0 A_TakeInventory("SamsaraDoomguyStrPlasmaRifleReadySoundCheck")
        64PR A 1 A_Raise
        goto Select

      Fire64:
        TNT1 A 0 A_PlaySound("doom64guy/plasmaidle",CHAN_6,1,true)
        TNT1 A 0 A_GiveInventory("SamsaraDoom64PlasmaRifleSoundActive")
        TNT1 A 0 A_TakeInventory("SamsaraDoomguyStrPlasmaRifleReadySoundCheck")
		TNT1 A 0 A_JumpIfInventory("SamsaraImprovedDoomguyBalance",1,"Fire64ImprovedBalance")
      Fire64VanillaBalance:
		TNT1 A 0 A_JumpIfInventory("SamsaraUsingSmoothAnims",1,"Fire64VanillaBalanceSmooth")
      Fire64VanillaBalanceVanilla:
        TNT1 A 0 A_GunFlash("Flash64",GFF_NOEXTCHANGE)
        64PR A 5 A_GiveInventory("SamsaraDoomguy64PlasmaRifleAttackHandler")
      Fire64Finish:
        TNT1 A 0 A_ReFire
        goto Ready

      Fire64ImprovedBalance:
		TNT1 A 0 A_JumpIfInventory("SamsaraUsingSmoothAnims",1,"Fire64ImprovedBalanceSmooth")
      Fire64ImprovedBalanceVanilla:
        TNT1 A 0 A_GunFlash("Flash64Improved",GFF_NOEXTCHANGE)
        64PR A 4 A_GiveInventory("SamsaraDoomguy64PlasmaRifleAttackHandler")
        64PR A 20 A_ReFire
        goto Ready

      Flash64:
        64RF A 4 Bright A_Light1
        goto LightDone

      Flash64Improved:
        TNT1 A 0 A_Light1
        64RF A 3 Bright A_JumpIfInventory("SamsaraHasDoubleFiringSpeed",1,"Flash64ImprovedRage")
        goto LightDone

      Flash64ImprovedRage:
        64RF A 2 Bright
        goto LightDone

      Fire64VanillaBalanceSmooth:
        TNT1 A 0 A_GunFlash("Flash64Smooth",GFF_NOEXTCHANGE)
        64PR I 2 A_GiveInventory("SamsaraDoomguy64PlasmaRifleAttackHandler")
		64PR J 3
        goto Fire64Finish

      Fire64ImprovedBalanceSmooth:
        64PR A 0 A_GunFlash("Flash64ImprovedSmooth",GFF_NOEXTCHANGE)
        64PR I 2 A_GiveInventory("SamsaraDoomguy64PlasmaRifleAttackHandler")
		64PR J 2
        64PR E 5 A_ReFire
        64PR FGH 5
        goto Ready

      Flash64Smooth:
		TNT1 A 4 Bright A_Light1
		goto LightDone

      Flash64ImprovedSmooth:
        TNT1 A 0 A_Light1
        TNT1 A 3 Bright A_JumpIfInventory("SamsaraHasDoubleFiringSpeed",1,"Flash64ImprovedSmoothRage")
        goto LightDone

      Flash64ImprovedSmoothRage:
        TNT1 A 2 Bright
        goto LightDone

      // Stronghold
      // Unpowered
      ReadyStr: // This is messy, but it must be done.
        TNT1 A 0 A_PlaySound("doomguy/stronghold/plasmariflehum",CHAN_6,1,true)
        TNT1 A 0 A_TakeInventory("SamsaraDoom64PlasmaRifleSoundActive")
        TNT1 A 0 A_GiveInventory("SamsaraDoomguyStrPlasmaRifleReadySoundCheck")
      ReadyStr1:
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrWeaponPower",1,"ReadyStr1Powered")
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrWeaponPowerPerma",1,"ReadyStr1Powered")
        DPLS I 1 Bright A_WeaponReady(WRF_NOSECONDARY)
      ReadyStr2:
        TNT1 A 0 A_JumpIfInventory("SamsaraHasDoubleFiringSpeed",1,"ReadyStr3")
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrWeaponPower",1,"ReadyStr2Powered")
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrWeaponPowerPerma",1,"ReadyStr2Powered")
        DPLS I 1 Bright A_WeaponReady(WRF_NOSECONDARY)
      ReadyStr3:
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrWeaponPower",1,"ReadyStr3Powered")
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrWeaponPowerPerma",1,"ReadyStr3Powered")
        DPLS I 1 Bright A_WeaponReady(WRF_NOSECONDARY)
      ReadyStr4:
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrWeaponPower",1,"ReadyStr4Powered")
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrWeaponPowerPerma",1,"ReadyStr4Powered")
        DPLS J 1 Bright A_WeaponReady(WRF_NOSECONDARY)
      ReadyStr5:
        TNT1 A 0 A_JumpIfInventory("SamsaraHasDoubleFiringSpeed",1,"ReadyStr6")
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrWeaponPower",1,"ReadyStr5Powered")
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrWeaponPowerPerma",1,"ReadyStr5Powered")
        DPLS J 1 Bright A_WeaponReady(WRF_NOSECONDARY)
      ReadyStr6:
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrWeaponPower",1,"ReadyStr6Powered")
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrWeaponPowerPerma",1,"ReadyStr6Powered")
        DPLS J 1 Bright A_WeaponReady(WRF_NOSECONDARY)
      ReadyStr7:
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrWeaponPower",1,"ReadyStr7Powered")
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrWeaponPowerPerma",1,"ReadyStr7Powered")
        DPLS K 1 Bright A_WeaponReady(WRF_NOSECONDARY)
      ReadyStr8:
        TNT1 A 0 A_JumpIfInventory("SamsaraHasDoubleFiringSpeed",1,"ReadyStr9")
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrWeaponPower",1,"ReadyStr8Powered")
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrWeaponPowerPerma",1,"ReadyStr8Powered")
        DPLS K 1 Bright A_WeaponReady(WRF_NOSECONDARY)
      ReadyStr9:
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrWeaponPower",1,"ReadyStr9Powered")
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrWeaponPowerPerma",1,"ReadyStr9Powered")
        DPLS K 1 Bright A_WeaponReady(WRF_NOSECONDARY)
        goto Ready

      DeselectStartStr:
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrWeaponPower",1,"DeselectStartStrPowered")
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrWeaponPowerPerma",1,"DeselectStartStrPowered")
      DeselectStartStrContinue:
        TNT1 A 0 A_Lower
        DPLS M 1 A_Lower
        goto Deselect

      SelectStr:
        TNT1 A 0 A_JumpIfInventory("SamsaraDoom64PlasmaRifleSoundActive",1,"SelectStrStopSound")
      SelectStartStr:
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrWeaponPower",1,"SelectStartStrPowered")
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrWeaponPowerPerma",1,"SelectStartStrPowered")
      SelectStartStrContinue:
        TNT1 A 0 A_Raise
        DPLS M 1 A_Raise
        goto Select

      SelectStrStopSound:
        TNT1 A 0 A_PlaySound("silence",CHAN_6)
        TNT1 A 0 A_StopSound(CHAN_6)
        TNT1 A 0 A_TakeInventory("SamsaraDoom64PlasmaRifleSoundActive")
        goto SelectStartStr

      FireStr:
        TNT1 A 0 A_JumpIfInventory("SamsaraDoom64PlasmaRifleSoundActive",1,"FireStrStopSound")
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrPlasmaRifleReadySoundCheck",1,"FireStrStopSound")
      FireStrStart:
        TNT1 A 0 A_GunFlash("FlashStr",GFF_NOEXTCHANGE)
        DPLS N 1 Bright A_GiveInventory("SamsaraDoomguyStrPlasmaRifleAttackHandler")
        TNT1 A 0 A_JumpIfInventory("SamsaraHasDoubleFiringSpeed",1,2)
        DPLS OP 1 Bright
        DPLS L 20 Bright A_ReFire
        goto Ready

      FireStrStopSound:
        TNT1 A 0 A_PlaySound("silence",CHAN_6)
        TNT1 A 0 A_StopSound(CHAN_6)
        TNT1 A 0 A_TakeInventory("SamsaraDoom64PlasmaRifleSoundActive")
        TNT1 A 0 A_TakeInventory("SamsaraDoomguyStrPlasmaRifleReadySoundCheck")
        goto FireStrStart

      FlashStr:
        TNT1 A 1 A_Light1
        TNT1 A 1 A_Light2
        TNT1 A 1 A_Light1
        goto LightDone

      // Powered
      ReadyStr1Powered:
        TNT1 A 0 A_JumpIfInventory("DoomClassMode",2,2)
        DPLS I 1 Bright A_WeaponReady(WRF_NOSECONDARY)
        goto ReadyStr2
        DPLS I 1 Bright A_WeaponReady
        goto ReadyStr2

      ReadyStr2Powered:
        TNT1 A 0 A_JumpIfInventory("DoomClassMode",2,2)
        DPLS I 1 Bright A_WeaponReady(WRF_NOSECONDARY)
        goto ReadyStr3
        DPLS I 1 Bright A_WeaponReady
        goto ReadyStr3

      ReadyStr3Powered:
        TNT1 A 0 A_JumpIfInventory("DoomClassMode",2,2)
        DPLS I 1 Bright A_WeaponReady(WRF_NOSECONDARY)
        goto ReadyStr4
        DPLS I 1 Bright A_WeaponReady
        goto ReadyStr4

      ReadyStr4Powered:
        TNT1 A 0 A_JumpIfInventory("DoomClassMode",2,2)
        DPLS J 1 Bright A_WeaponReady(WRF_NOSECONDARY)
        goto ReadyStr5
        DPLS J 1 Bright A_WeaponReady
        goto ReadyStr5

      ReadyStr5Powered:
        TNT1 A 0 A_JumpIfInventory("DoomClassMode",2,2)
        DPLS J 1 Bright A_WeaponReady(WRF_NOSECONDARY)
        goto ReadyStr6
        DPLS J 1 Bright A_WeaponReady
        goto ReadyStr6

      ReadyStr6Powered:
        TNT1 A 0 A_JumpIfInventory("DoomClassMode",2,2)
        DPLS J 1 Bright A_WeaponReady(WRF_NOSECONDARY)
        goto ReadyStr7
        DPLS J 1 Bright A_WeaponReady
        goto ReadyStr7

      ReadyStr7Powered:
        TNT1 A 0 A_JumpIfInventory("DoomClassMode",2,2)
        DPLS K 1 Bright A_WeaponReady(WRF_NOSECONDARY)
        goto ReadyStr8
        DPLS K 1 Bright A_WeaponReady
        goto ReadyStr8

      ReadyStr8Powered:
        TNT1 A 0 A_JumpIfInventory("DoomClassMode",2,2)
        DPLS K 1 Bright A_WeaponReady(WRF_NOSECONDARY)
        goto ReadyStr9
        DPLS K 1 Bright A_WeaponReady
        goto ReadyStr9

      ReadyStr9Powered:
        TNT1 A 0 A_JumpIfInventory("DoomClassMode",2,2)
        DPLS K 1 Bright A_WeaponReady(WRF_NOSECONDARY)
        goto Ready
        DPLS K 1 Bright A_WeaponReady
        goto Ready

      DeselectStartStrPowered:
        TNT1 A 0 A_Lower
        goto DeselectStartStrContinue

      SelectStartStrPowered:
        TNT1 A 0 A_Raise
        goto SelectStartStrContinue

      AltFire:
        TNT1 A 0 A_JumpIfInventory("SamsaraDoom64PlasmaRifleSoundActive",1,"AltFireStopSound")
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrPlasmaRifleReadySoundCheck",1,"AltFireStopSound")
      AltFireStart:
        TNT1 A 0 A_GunFlash("FlashStr",GFF_NOEXTCHANGE)
        DPLS N 1 Bright A_GiveInventory("SamsaraDoomguyStrPlasmaRiflePoweredSecondaryAttackHandler")
        TNT1 A 0 A_JumpIfInventory("SamsaraHasDoubleFiringSpeed",1,2)
        DPLS OP 1 Bright
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrWeaponPower",1,"AltFireFinishReFire")
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrWeaponPowerPerma",1,"AltFireFinishReFire")
        TNT1 A 0 A_CheckReload
      AltFireFinish:
        DPLS L 20 Bright
        goto Ready

      AltFireFinishReFire:
        TNT1 A 0 A_JumpIfInventory("DoomClassMode",2,2)
        TNT1 A 0 A_CheckReload
        goto AltFireFinish
        TNT1 A 0 A_ReFire
        goto AltFireFinish

      AltFireStopSound:
        TNT1 A 0 A_PlaySound("silence",CHAN_6)
        TNT1 A 0 A_StopSound(CHAN_6)
        TNT1 A 0 A_TakeInventory("SamsaraDoom64PlasmaRifleSoundActive")
        TNT1 A 0 A_TakeInventory("SamsaraDoomguyStrPlasmaRifleReadySoundCheck")
        goto AltFireStart
    }
}

actor SamsaraDoomguyPlasmaRifleAttackHandler : Trigger
{
    States
    {
      // Ammo checking/taking stuff
      Pickup:
        TNT1 A 0 A_JumpIfInventory("SamsaraHasInfiniteAmmo",1,"PickupAttack")
        TNT1 A 0 A_JumpIfInventory("Cell",1,1)
        stop
        TNT1 A 0 A_TakeInventory("Cell",1)
        goto PickupAttack

      // Attack stuff
      PickupAttack:
        TNT1 A 0 A_JumpIfInventory("SPModeOn",1,"PickupAttackCoop")
        TNT1 A 0 A_JumpIfInventory("CoopModeOn",1,"PickupAttackCoop")
      PickupAttackDM:
        TNT1 A 0 A_FireCustomMissile("DoomPlasmaBall",0,false)
        stop

      PickupAttackCoop:
        TNT1 A 0 A_FireCustomMissile("DoomPlasmaBall2",0,false)
        stop
    }
}

actor DoomPlasmaBall : PlasmaBall
{
    Decal DoomPlasmaScorch
    SeeSound "doomguy/plasmaf"
    DeathSound "doomguy/plasmax"
    Obituary "$SAMSARA_DOOMGUY_OB_SLOT6"
    DamageType "DoomDamageType"
    States
    {
      Spawn:
        DPLM AB 6 bright
        loop

      Death:
        DPLE ABCDE 4 bright
        stop
    }
}

actor DoomPlasmaBall2 : DoomPlasmaBall { +THRUSPECIES Species "Player" }

actor SamsaraDoomguy64PlasmaRifleAttackHandler : Trigger
{
    States
    {
      // Ammo checking/taking stuff
      Pickup:
        TNT1 A 0 A_JumpIfInventory("SamsaraHasInfiniteAmmo",1,"PickupAttack")
        TNT1 A 0 A_JumpIfInventory("Cell",1,1)
        stop
        TNT1 A 0 A_TakeInventory("Cell",1)
        goto PickupAttack

      // Attack stuff
      PickupAttack:
        TNT1 A 0 A_JumpIfInventory("SPModeOn",1,"PickupAttackCoop")
        TNT1 A 0 A_JumpIfInventory("CoopModeOn",1,"PickupAttackCoop")
      PickupAttackDM:
        TNT1 A 0 A_FireCustomMissile("Doom64PlasmaBall",0,false)
        stop

      PickupAttackCoop:
        TNT1 A 0 A_FireCustomMissile("Doom64PlasmaBall2",0,false)
        stop
    }
}

actor Doom64PlasmaBall : PlasmaBall
{
    Decal Doom64PlasmaScorch
    RenderStyle Normal
    Alpha 1
	Speed 32
    Scale 0.75
    +BLOODLESSIMPACT
    SeeSound "doom64guy/plasmaf"
    DeathSound "doom64guy/plasmax"
    Obituary "%k \cpfried\c- %o \cpwith the Plasma Gun.\c-"
    DamageType "DoomPlasma"
    Damage 6 // slightly higher damage to make up for drastically slower ROF
    States
    {
      Spawn:
        64PB AB 3 bright
        loop

      Death:
        64PB CDEFGH 2 bright
        stop
    }
}

actor Doom64PlasmaBall2 : Doom64PlasmaBall { +THRUSPECIES Species "Player" }

// Primary attack handler

actor SamsaraDoomguyStrPlasmaRifleAttackHandler : Trigger
{
    States
    {
      // Ammo checking/taking stuff
      Pickup:
        TNT1 A 0 A_JumpIfInventory("SamsaraHasInfiniteAmmo",1,"PickupAttack")
        TNT1 A 0 A_JumpIfInventory("Cell",1,1)
        stop
        TNT1 A 0 A_TakeInventory("Cell",1)
        goto PickupAttack

      // Attack stuff
      PickupAttack:
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrWeaponPower",1,"PickupAttackPowered")
        TNT1 A 0 A_JumpIfInventory("SamsaraDoomguyStrWeaponPowerPerma",1,"PickupAttackPowered")
      // Unpowered
      PickupAttackUnpowered:
        TNT1 A 0 A_JumpIfInventory("SPModeOn",1,"PickupAttackUnpoweredCoop")
        TNT1 A 0 A_JumpIfInventory("CoopModeOn",1,"PickupAttackUnpoweredCoop")
      PickupAttackUnpoweredDM:
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyStrPlasmaBall",0,false)
        stop

      PickupAttackUnpoweredCoop:
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyStrPlasmaBallCoop",0,false)
        stop

      // Powered
      PickupAttackPowered:
        TNT1 A 0 A_JumpIfInventory("SPModeOn",1,"PickupAttackPoweredCoop")
        TNT1 A 0 A_JumpIfInventory("CoopModeOn",1,"PickupAttackPoweredCoop")
      PickupAttackPoweredDM:
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyStrPowerPlasmaBall",0,false)
        stop

      PickupAttackPoweredCoop:
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyStrPowerPlasmaBallCoop",0,false)
        stop
    }
}

// Secondary (powered) attack handler

actor SamsaraDoomguyStrPlasmaRiflePoweredSecondaryAttackHandler : Trigger
{
    States
    {
      // Ammo checking/taking stuff
      Pickup:
        TNT1 A 0 A_JumpIfInventory("SamsaraHasInfiniteAmmo",1,"PickupAttack")
        TNT1 A 0 A_JumpIfInventory("Cell",1,1)
        stop
        TNT1 A 0 A_TakeInventory("Cell",1)
        goto PickupAttack

      // Attack stuff
      PickupAttack:
        TNT1 A 0 A_JumpIfInventory("SPModeOn",1,"PickupAttackCoop")
        TNT1 A 0 A_JumpIfInventory("CoopModeOn",1,"PickupAttackCoop")
      PickupAttackDM:
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyStrPowerPlasmaBall2",random(-150,150)/100.0,false,0,0,0,random(-150,150)/100.0)
        stop

      PickupAttackCoop:
        TNT1 A 0 A_FireCustomMissile("SamsaraDoomguyStrPowerPlasmaBall2Coop",random(-150,150)/100.0,false,0,0,0,random(-150,150)/100.0)
        stop
    }
}

// Plasma ball

actor SamsaraDoomguyStrPlasmaBall : PlasmaBall
{
    DamageType "DoomDamageType"
    SeeSound "doomguy/stronghold/plasmaf"
    DeathSound "doomguy/stronghold/plasmax"
    Decal "DoomStrPlasmaScorch"
    States
    {
      Spawn:
        DPLM CD 6 Bright Light("PLASMABALL")
        loop

      Death:
        DPLE F 4 Bright Light("PLASMA_X1")
        DPLE GH 4 Bright Light("PLASMA_X2")
        DPLE I 4 Bright Light("PLASMA_X3")
        DPLE J 4 Bright Light("PLASMA_X4")
        stop
    }
}

actor SamsaraDoomguyStrPlasmaBallCoop : SamsaraDoomguyStrPlasmaBall
{
    Species "Player"
    +THRUSPECIES
}

// Powered plasma ball

actor SamsaraDoomguyStrPowerPlasmaBall : SamsaraDoomguyStrPlasmaBall
{
    Radius 22.75
    Height 14
    Speed 30
    Damage (40)
    DamageType "DoomDamageTypeNoSelfDamage"
    Alpha 1
    Scale 0.8
    +FORCERADIUSDMG
    States
    {
      Spawn:
        DPLE F 2 Bright Light("POWERPLASMA_X1") A_SpawnItemEx("SamsaraDoomguyStrPowerPlasmaBallTrail",random(-1,1),random(-1,1),random(-1,1),random(-1,1),random(-1,1),random(-1,1),random(0,359))
        loop

      Death:
        TNT1 A 0 A_GiveToTarget("SamsaraDoomguyNoSelfDamage")
        TNT1 A 0 A_Explode(40,80)
        TNT1 A 0 A_TakeFromTarget("PowerSamsaraDoomguyNoSelfDamage")
      DeathFinish:
        DPLE F 4 Bright Light("POWERPLASMA_X1")
        DPLE GH 4 Bright Light("POWERPLASMA_X2")
        DPLE I 4 Bright Light("POWERPLASMA_X3")
        DPLE J 4 Bright Light("POWERPLASMA_X4")
        stop
    }
}

actor SamsaraDoomguyStrPowerPlasmaBallCoop : SamsaraDoomguyStrPowerPlasmaBall
{
    Species "Player"
    +THRUSPECIES
}

// Powered homing plasma ball

actor SamsaraDoomguyStrPowerPlasmaBall2 : SamsaraDoomguyStrPowerPlasmaBall
{
    Speed 60
    Damage (60)
    DamageType "DoomDamageType"
    -FORCERADIUSDMG
    +SEEKERMISSILE
    States
    {
      Spawn:
        DPLE F 1 Bright Light("POWERPLASMA_X1")
      SpawnLoop:
        TNT1 A 0 A_SeekerMissile(2,10,SMF_LOOK,50,10)
        DPLE F 1 Bright Light("POWERPLASMA_X1") A_SpawnItemEx("SamsaraDoomguyStrPowerPlasmaBallTrail")
        loop

      Death:
        goto DeathFinish
    }
}

actor SamsaraDoomguyStrPowerPlasmaBall2Coop : SamsaraDoomguyStrPowerPlasmaBall2
{
    Species "Player"
    +THRUSPECIES
}

// Powered plasma ball trail

actor SamsaraDoomguyStrPowerPlasmaBallTrail : SamsaraDoomguyStrElectricalPuff
{
    SeeSound ""
    AttackSound ""
    Decal ""
    +CLIENTSIDEONLY
    +NOTONAUTOMAP
}
