actor DGHasMinigun : Boolean {}
actor SamsaraDoomguyStrMinigunFiringSoundCheck : Boolean {}
actor SamsaraDoomguyStrMinigunPoweredAttackAmount : Counter { Inventory.MaxAmount 2 }

ACTOR " Minigun " : Weapon
{
	Radius 20
	Height 16
	Weapon.AmmoType "Clip" 
	Weapon.AmmoGive 0
	Weapon.AmmoUse 1
	Weapon.Selectionorder 700
	Weapon.Kickback 100
	Weapon.SlotNumber 4 // This line isn't in skulltag.pk3, which instead defines the slot directly in DoomPlayer
	Inventory.PickupMessage "$PICKUP_MINIGUN" // "You got the minigun!"
	Inventory.RestrictedTo "DoomguyPlayer"
	Obituary "$OB_MINIGUN" // "%o was drilled by %k's minigun."
	Tag "Minigun"
	States
	{
		Spawn:
			MNGN A -1
			loop
		Ready:
			MNGG A 1 A_WeaponReady
			loop
		Deselect:
			MNGG A 1 A_Lower
			loop
		Select: 
			MNGG A 1 A_Raise 
			loop  
		Fire: 
			TNT1 A 0 A_GunFlash
			MNGG A 2 A_GiveInventory("SamsaraDoomguyMinigunAttackHandler")
            TNT1 A 0 A_JumpIfInventory("SamsaraHasInfiniteAmmo",1,"Fire2Attack")
            TNT1 A 0 A_JumpIfInventory("Clip",1,"Fire2Attack")
            goto Fire2
        Fire2Attack:
            TNT1 A 0 A_GunFlash("Flash2")
        Fire2:
            MNGG B 2 A_GiveInventory("SamsaraDoomguyMinigunAttackHandler")
        FireFinish:
			MNGG A 2 A_ReFire
			MNGG B 2
			MNGG AB 4
			MNGG AB 8
			goto Ready
        Flash:
			MNGF A 3 Bright A_Light1
            goto LightDone
        Flash2:
			MNGF B 3 Bright A_Light2
			goto LightDone
	}
}

actor SamsaraDoomguyMinigunAttackHandler : Trigger
{
    States
    {
      // Ammo check stuff
      Pickup:
        TNT1 A 0 A_JumpIfInventory("SamsaraHasInfiniteAmmo",1,"PickupTakeAmmo")
        TNT1 A 0 A_JumpIfInventory("Clip",1,"PickupTakeAmmo")
        stop

      // Ammo taking stuff
      PickupTakeAmmo:
        TNT1 A 0 A_TakeInventory("Clip",1,TIF_NOTAKEINFINITE)
        goto PickupAttack

      // Attack stuff
      PickupAttack:
        TNT1 A 0 A_PlaySound("weapons/minigun",CHAN_WEAPON)
        TNT1 A 0 A_JumpIfInventory("SamsaraImprovedDoomguyBalance",1,"PickupAttackImproved")
      // Vanilla
      PickupAttackVanilla:
        TNT1 A 0 A_JumpIfInventory("SPModeOn",1,"PickupAttackVanillaCoop")
        TNT1 A 0 A_JumpIfInventory("CoopModeOn",1,"PickupAttackVanillaCoop")
      PickupAttackVanillaDM:
        TNT1 A 0 A_FireBullets(5.6,0,1,5,"DoomBulletPuff2ThruGhost",FBF_NOFLASH)
        stop

      PickupAttackVanillaCoop:
        TNT1 A 0 A_FireBullets(5.6,0,1,5,"DoomBulletPuff2ThruGhost_Coop",FBF_NOFLASH)
        stop

      // Improved
      PickupAttackImproved:
        TNT1 A 0 A_JumpIfInventory("SPModeOn",1,"PickupAttackImprovedCoop")
        TNT1 A 0 A_JumpIfInventory("CoopModeOn",1,"PickupAttackImprovedCoop")
      PickupAttackImprovedDM:
        TNT1 A 0 A_FireBullets(5.6,0,1,random(8,10)*2,"DoomBulletPuff2ThruGhost",FBF_NORANDOM|FBF_NOFLASH)
        stop

      PickupAttackImprovedCoop:
        TNT1 A 0 A_FireBullets(5.6,0,1,random(8,10)*2,"DoomBulletPuff2ThruGhost_Coop",FBF_NORANDOM|FBF_NOFLASH)
        stop
    }
}
