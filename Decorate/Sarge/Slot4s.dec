Actor Q3HMGSkipFlash : Q3Boolean {}
Actor Q3HeavyMachineGun : Q3Weapon
{
	Weapon.SlotNumber 4
	Weapon.AmmoUse 1
	Weapon.AmmoGive 20
	Weapon.AmmoType "Clip"
	Inventory.PickupMessage "Heavy Machine Gun"
	Obituary "%o was ripped by %k's HMG."
	Tag "Heavy Machine Gun"
	+FLOATBOB
	States
	{
		Spawn:
			Q399 A -1
			stop

		ReadyActual:
			Q300 A 1 A_WeaponReady
			loop

		Deselect:
            Q301 A 0 A_JumpIfHealthLower(1,"DeselectInstant")
			Q301 A 1 A_PlaySound("Quake3/Weapons/Change",CHAN_5)
			Q301 BCDE 1
			goto DeselectInstant

		Ready: // our "Select" state
			Q302 ABCD 1
            goto ReadyActual

		Fire:
            Q303 A 0 A_JumpIfInventory("SamsaraHasInfiniteAmmo",1,"FireStart")
            Q303 A 0 A_JumpIfInventory("Clip",1,"FireStart")
            goto FireDry

        FireDry:
			Q300 A 0 A_PlaySound("Quake3/Weapons/NoAmmo",CHAN_5)
            Q300 A 17 A_WeaponReady(WRF_NOSWITCH|WRF_NOFIRE)
			Q300 A 0 A_SelectWeapon("Q3Machinegun")
			goto Deselect

        FireStart:
			Q303 A 0 A_GunFlash("FlashA",GFF_NOEXTCHANGE)
			Q303 A 0 A_GiveInventory("SamsaraQuake3HMGAttackHandler")
			Q303 A 2 A_WeaponReady(WRF_NOSWITCH|WRF_NOFIRE)
			Q303 B 0 A_Refire(1)
			Goto ReadyActual
			Q303 B 0 A_GunFlash("FlashB",GFF_NOEXTCHANGE)
			Q303 B 0 A_GiveInventory("SamsaraQuake3HMGAttackHandler")
			Q303 A 2 A_WeaponReady(WRF_NOSWITCH|WRF_NOFIRE)
			Q303 C 0 A_Refire(1)
			Goto ReadyActual
			Q303 C 0 A_GunFlash("FlashC",GFF_NOEXTCHANGE)
			Q303 C 0 A_GiveInventory("SamsaraQuake3HMGAttackHandler")
			Q303 A 2 A_WeaponReady(WRF_NOSWITCH|WRF_NOFIRE)
			Q303 D 0 A_Refire(1)
			Goto ReadyActual
			Q303 D 0 A_GunFlash("FlashD",GFF_NOEXTCHANGE)
			Q303 D 0 A_GiveInventory("SamsaraQuake3HMGAttackHandler")
			Q303 A 2 A_WeaponReady(WRF_NOSWITCH|WRF_NOFIRE)
			Q303 E 0 A_Refire(1)
			Goto ReadyActual
			Q303 E 0 A_GunFlash("FlashE",GFF_NOEXTCHANGE)
			Q303 E 0 A_GiveInventory("SamsaraQuake3HMGAttackHandler")
			Q303 A 2 A_WeaponReady(WRF_NOSWITCH|WRF_NOFIRE)
			Q303 F 0 A_Refire(1)
			Goto ReadyActual
			Q303 F 0 A_GunFlash("FlashF",GFF_NOEXTCHANGE)
			Q303 F 0 A_GiveInventory("SamsaraQuake3HMGAttackHandler")
			Q303 A 2 A_WeaponReady(WRF_NOSWITCH|WRF_NOFIRE)
			Q303 A 0 A_Refire("FireStart")
			Goto ReadyActual
			
		NoFlash:
			TNT1 A 1
			Stop
		FlashA:
			TNT1 A 0 A_JumpIfInventory("Q3HMGSkipFlash",1,2)
			Q304 A 2 Bright
			Q304 B 0
			Stop
		FlashB:
			TNT1 A 0 A_JumpIfInventory("Q3HMGSkipFlash",1,2)
			Q304 B 2 Bright
			Q304 C 0
			Stop
		FlashC:
			TNT1 A 0 A_JumpIfInventory("Q3HMGSkipFlash",1,2)
			Q304 C 2 Bright
			Q304 D 0
			Stop
		FlashD:
			TNT1 A 0 A_JumpIfInventory("Q3HMGSkipFlash",1,2)
			Q304 D 2 Bright
			Q304 E 0
			Stop
		FlashE:
			TNT1 A 0 A_JumpIfInventory("Q3HMGSkipFlash",1,2)
			Q304 E 2 Bright
			Q304 F 0
			Stop
		FlashF:
			TNT1 A 0 A_JumpIfInventory("Q3HMGSkipFlash",1,2)
			Q304 F 2 Bright
			Q304 A 0
			Stop
	}
}

actor SamsaraQuake3HMGAttackHandler : Trigger
{
    States
    {
      // Ammo checking/taking stuff
      Pickup:
        TNT1 A 0 A_JumpIfInventory("SamsaraHasInfiniteAmmo",1,"PickupAttack")
        TNT1 A 0 A_JumpIfInventory("Clip",1,1)
        stop
        TNT1 A 0 A_TakeInventory("Clip",1)
        goto PickupAttack

      // Attack stuff
      PickupAttack:
		TNT1 A 0 A_JumpIfInventory("Q3HMGSkipFlash",1,2)
		TNT1 A 0 A_GiveInventory("Q3HMGSkipFlash")
		Goto PickupAttack+3
		TNT1 A 0 A_TakeInventory("Q3HMGSkipFlash")
		TNT1 A 0 A_AlertMonsters
        TNT1 A 0 A_PlaySound("Quake3/HMG/Fire",CHAN_WEAPON)
        TNT1 A 0 A_GiveInventory("Q3QuadDamageSound")
        TNT1 A 0 A_JumpIfInventory("SPModeOn",1,"PickupAttackCoop")
        TNT1 A 0 A_JumpIfInventory("CoopModeOn",1,"PickupAttackCoop")
      PickupAttackDM:
        TNT1 A 0 A_FireBullets(2,2,-1,16,"Q3ShotgunPuff",FBF_NORANDOM|FBF_NOFLASH|FBF_NORANDOMPUFFZ)
        stop

      PickupAttackCoop:
        TNT1 A 0 A_FireBullets(2,2,-1,16,"Q3ShotgunPuffCoop",FBF_NORANDOM|FBF_NOFLASH|FBF_NORANDOMPUFFZ)
        stop
    }
}