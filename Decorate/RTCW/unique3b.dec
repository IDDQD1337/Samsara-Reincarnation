Actor RTCW_Pineapple : RTCW_Grenade
{
	Weapon.SlotPriority 1
	Weapon.SelectionOrder 1900
	Weapon.AmmoType "RTCW_AlliedAmmo3"
	Obituary "%o was killed (gren - am) by %k."
	Inventory.Pickupmessage "Mk2 Grenade"
	Tag "Pineapple Grenade"
	States
	{
		Ready: // our "Select" state
			RW00 A 0 A_TakeInventory("RTCW_WeaponToken",256)
			RW00 A 0 A_GiveInventory("RTCW_WeaponToken",7)
			goto ReadyStart

        FireStart:
            RW00 B 0 A_TakeInventory("RTCW_GrenadeFuse")
            RW00 B 0 A_TakeInventory("RTCW_GrenadeTimer")
			RW00 B 0 A_PlaySound("RTCW/Grenade/Pulse4",CHAN_5)
            RW00 B 0 A_GiveInventory("RTCW_GrenadeFuse")
            RW00 B 1 A_WeaponReady(WRF_NOSWITCH|WRF_NOFIRE)
            RW00 B 0 A_GiveInventory("RTCW_GrenadeFuse")
            RW00 B 1 A_WeaponReady(WRF_NOSWITCH|WRF_NOFIRE)
            RW00 B 0 A_GiveInventory("RTCW_GrenadeFuse")
            RW00 B 1 A_WeaponReady(WRF_NOSWITCH|WRF_NOFIRE)
            RW00 C 0 A_GiveInventory("RTCW_GrenadeFuse")
            RW00 C 1 A_WeaponReady(WRF_NOSWITCH|WRF_NOFIRE)
            RW00 C 0 A_GiveInventory("RTCW_GrenadeFuse")
            RW00 C 1 A_WeaponReady(WRF_NOSWITCH|WRF_NOFIRE)
            RW00 C 0 A_GiveInventory("RTCW_GrenadeFuse")
            RW00 C 1 A_WeaponReady(WRF_NOSWITCH|WRF_NOFIRE)
		GrenadeHold:
			RW00 C 0 A_JumpIfInventory("RTCW_GrenadeTimer",0,"ReleaseGrenade")
			RW00 C 0 A_JumpIfInventory("RTCW_GrenadeFuse",0,"GrenadeTimerUp")
			RW00 C 0 A_GiveInventory("RTCW_GrenadeFuse")
            RW00 C 1 A_WeaponReady(WRF_NOSWITCH|WRF_NOFIRE)
			RW00 C 0 A_ReFire("GrenadeHold")
			Goto ReleaseGrenade

		GrenadeTimerUp:
			RW00 C 0 A_TakeInventory("RTCW_GrenadeFuse")
			RW00 C 0 A_GiveInventory("RTCW_GrenadeTimer")
			RW00 C 0 A_JumpIfInventory("RTCW_GrenadeTimer",0,"GrenadeHold")
			RW00 C 0 A_JumpIfInventory("RTCW_GrenadeTimer",3,4)
			RW00 C 0 A_JumpIfInventory("RTCW_GrenadeTimer",2,2)
			RW00 C 0 A_PlaySound("RTCW/Grenade/Pulse3",CHAN_5)
			Goto GrenadeHold
			RW00 C 0 A_PlaySound("RTCW/Grenade/Pulse2",CHAN_5)
			Goto GrenadeHold
			RW00 C 0 A_PlaySound("RTCW/Grenade/Pulse1",CHAN_5)
			Goto GrenadeHold

		ReleaseGrenade:
			RW00 B 0 A_GiveInventory("RTCW_FiringToken",1)
        ReleaseGrenadeEndCheck:
            RW00 B 0 A_JumpIfInventory("SamsaraHasInfiniteAmmo",1,"ReleaseGrenadeEnd")
            RW00 B 0 A_JumpIfInventory("RTCW_AlliedAmmo3",2,"ReleaseGrenadeEnd")
            goto ReleaseGrenadeEndLast

        ReleaseGrenadeEnd:
            RW00 B 0 A_GiveInventory("SamsaraRTCWPineappleAttackHandler")
            RW00 B 3 A_WeaponReady(WRF_NOSWITCH|WRF_NOFIRE)
            TNT1 A 35 A_WeaponReady(WRF_NOSWITCH|WRF_NOFIRE)
            goto ReadyActualNoAmmoCheck

        ReleaseGrenadeEndLast:
            RW00 B 0 A_PlaySound("RTCW/NoAmmo",CHAN_5)
            RW00 B 0 A_PlaySound("RTCW/Change",CHAN_7)
            RW00 B 0 A_GiveInventory("SamsaraRTCWPineappleAttackHandler")
            RW00 B 3 A_WeaponReady(WRF_NOSWITCH|WRF_NOFIRE)
            TNT1 A 35 A_WeaponReady(WRF_NOSWITCH|WRF_NOFIRE)
            TNT1 A 0 A_SelectWeapon("RTCW_Luger")
            goto RTCW_Weapon::Deselect
	}
}

actor SamsaraRTCWPineappleAttackHandler : Trigger
{
    States
    {
      // Ammo checking/taking stuff
      Pickup:
        TNT1 A 0 A_JumpIfInventory("SamsaraHasInfiniteAmmo",1,"PickupAttack")
        TNT1 A 0 A_JumpIfInventory("RTCW_AlliedAmmo3",1,1)
        stop
        TNT1 A 0 A_TakeInventory("RTCW_AlliedAmmo3",1)
        goto PickupAttack

      // Attack stuff
      PickupAttack:
        TNT1 A 0 A_PlaySound("RTCW/Grenade/Throw",CHAN_WEAPON)
        TNT1 A 0 A_JumpIfInventory("SPModeOn",1,"PickupAttackCoop")
        TNT1 A 0 A_JumpIfInventory("CoopModeOn",1,"PickupAttackCoop")
      PickupAttackDM:
        TNT1 A 0 A_FireCustomMissile("RTCW_PineappleProjectile",0,false,8,4)
        stop

      PickupAttackCoop:
        TNT1 A 0 A_FireCustomMissile("RTCW_PineappleProjectileCoop",0,false,8,4)
        stop
    }
}

Actor RTCW_PineappleProjectile : RTCW_GrenadeProjectile
{
	Speed 10
	States
	{
		Spawn:
			RW00 A 0 NoDelay A_GiveInventory("RTCW_GrenadeTimer",CallACS("RTCW_Decorate",7))
            RW00 A 0 A_JumpIfInventory("RTCW_GrenadeTimer",0,"Detonate")
			RW00 A 0 ThrustThingZ(0,20,0,1)
		SpawnLoop:
			RW00 AAAAAAAAAAAAAAAAAAAAAAAA 1
			RW00 A 0 A_GiveInventory("RTCW_GrenadeTimer",1)
			RW00 A 0 A_JumpIfInventory("RTCW_GrenadeTimer",0,"Detonate")
			Goto SpawnLoop
		Bounce:
			RW00 A 0 A_ChangeFlag("USEBOUNCESTATE",0)
			RW00 AAAAAAAAAAAAAAAAAAAAAAAA 1 A_SpawnItemEx("RTCW_GrenadeTrailSmoke")
			RW00 A 0 A_GiveInventory("RTCW_GrenadeTimer",1)
			RW00 A 0 A_JumpIfInventory("RTCW_GrenadeTimer",0,"Detonate")
			Goto Bounce
		OnFloor:
			RW00 B 0 A_GiveInventory("RTCW_GrenadeTimer",1)
			RW00 B 17 A_JumpIfInventory("RTCW_GrenadeTimer",0,"Detonate")
			Loop
		Crash:
		Death:
		XDeath:
			RW00 A 0 A_Stop
			RW00 A 0 A_JumpIfInventory("RTCW_GrenadeTimer",0,1)
			Goto OnFloor
		Detonate:
			RW00 AAAA 0 A_SpawnItemEx("RTCW_PanzerfaustSmokeExplosion",0,0,0,frandom(-0.5,0.5),frandom(-0.5,0.5),1)
			RW00 AAAA 0 A_SpawnItemEx("RTCW_ExplosionSmokeDebris")
			RW00 A 0 A_GiveInventory("RTCW_BlazkoWeaponAlert",1,AAPTR_Target)
			RW00 A 0 A_Explode(375,120,XF_HURTSOURCE,1,0) // 80 is too small // values may need adjustment. hand detonation was 200,300
			RW00 A 0 A_SpawnItemEx("RTCW_PanzerfaustRocketExplosion")
			Stop
	}
}

Actor RTCW_PineappleProjectileCoop : RTCW_PineappleProjectile { +THRUSPECIES Species "Player" }
